;-------------------------------------------------
;ターン経過のイベント
;-------------------------------------------------
@TURN_EVENT(ARG)
#DIM L_I
#DIM L_P
#DIM L_P2
#DIM L_TGT_BAK

L_TGT_BAK = TARGET
L_P2 = 0
L_I = 0

FLAG:都市_合計ファン数 = 0

FOR L_I, 1, CHARANUM
	TARGET = L_I
	ARG =  L_I

	IF TARGET != MASTER  && TALENT:L_I:NPC != 999 && TALENT:L_I:부재 == 0
		;陥落ボーナスイベント
		SIF CFLAG:華燭の典 == 0 && (Talent:심취 == 1 || Talent:애인 == 1 || Talent:정부 == 1)
			CALL TURN_EVENT_FALL_BONUS
		CALL TURN_EVENT_NAYAMI_K
		IF CFLAG:레귤러 != 0
			CALL TURN_EVENT_NJ
			;交流イベント
			SIF CFLAG:住人交流設定 != 0 && RAND:100 < CFLAG:住人イベント傾向_交流
				CALL TURN_EVENT_COM
			CALL TURN_EVENT_MORAL
			CALL TURN_EVENT_FON
			CALL TURN_EVENT_F
			CALL TURN_EVENT_HNYU
			CALL TURN_EVENT_NTL
		ENDIF
		CALL TURN_EVENT_TL
		CALL TURN_EVENT_NAYAMI_K_END
		CALL TURN_EVENT_NAYAMI
		SIF RAND:100 >= 95
			CALL TURN_EVENT_NYM_R
		SIF CFLAG:妊娠フラグ != 0
			CALL NINSIN_MAIN(ARG)
		;必須イベント(回復等)
		CALL TURN_EVENT_RPG_P
		CALL TURN_EVENT_PERSONAL_END
		CALL TURN_EVENT_CITY_EXP
	ELSEIF TALENT:L_I:부재 == 1
		IF CFlag:拉致監禁 > 0 && FLAG:ＮＴＲモード == 1
			CALL TURN_EVENT_RPG_RK
		ENDIF
	ENDIF
NEXT
TARGET = L_TGT_BAK

IF RAND:100 >= 95 && Flag:都市_Lv >= 10 && FLAG:都市_防衛 == 0 && Flag:都市_襲撃 > 1 && Flag:EP他プレイヤー干渉 == 0
	Flag:EP他プレイヤー干渉 = 1
	Flag:EP敵戦力 = (RAND:((Flag:都市_Lv)+1))/10
	SIF Flag:EP敵戦力  <= 0
		Flag:EP敵戦力 = 1
	SIF Flag:EP敵戦力  >= 10
		Flag:EP敵戦力 = 10
ENDIF

IF Flag:EP他プレイヤー干渉 == 3 && FLAG:都市_防衛 == 0 && Flag:都市_襲撃 > 1
	CLEARLINE LINECOUNT
	DRAWLINE
	PRINTFORML 다른「플레이어」에게 이쪽 구획을 간섭당한 것 같다…
	PRINTFORML 【도시 Lv이 떨어졌습니다】
	DRAWLINE
	PRINTFORMW 
	Flag:都市_Lv -= (Flag:都市_Lv/5)+1
	Flag:EP他プレイヤー干渉 = 0
	Flag:EP敵戦力 = 0
	Flag:EP追撃方法 = 0
	Flag:EP成否 = 0
ELSEIF Flag:EP他プレイヤー干渉 != 0 && FLAG:都市_防衛 == 0 && Flag:都市_襲撃 > 1
	Flag:EP他プレイヤー干渉 += 1
ELSEIF Flag:EP他プレイヤー干渉 != 0 && (FLAG:都市_防衛 != 0 || Flag:都市_襲撃 <= 1)
	CLEARLINE LINECOUNT
	DRAWLINE
	PRINTFORML 다른「플레이어」는 외계의 이변을 감지하고 철수한 것 같다…
	DRAWLINE
	PRINTFORMW 
	Flag:EP他プレイヤー干渉 = 0
	Flag:EP敵戦力 = 0
	Flag:EP追撃方法 = 0
	Flag:EP成否 = 0
ENDIF


SIF RAND:10 > 7
	Flag:依頼_スパイテロ駆除_Lv = RAND:(Flag:都市_Lv+1)+2
SIF RAND:10 > 7
	Flag:依頼_イスからの駆除依頼_Lv = RAND:(Flag:都市_Lv+1)+3

IF FLAG:支援_체력回復サポート == 1 && Flag:都市_現在SP >= 7
	L_P2 = 6
	Flag:都市_現在SP -= 7
ENDIF

Flag:都市_現在AP += Flag:都市_最大AP / (10 - L_P2)
Flag:都市_現在SP += Flag:都市_最大SP / 2
Flag:都市_現在TP += Flag:都市_最大TP



IF RAND:100 > 50
	Flag:都市_天気 = 0
ELSE
	Flag:都市_天気 = RAND:4+1
ENDIF

SIF Flag:都市_現在AP >= Flag:都市_最大AP
	Flag:都市_現在AP = Flag:都市_最大AP
SIF Flag:都市_現在SP >= Flag:都市_最大SP
	Flag:都市_現在SP = Flag:都市_最大SP
SIF Flag:都市_現在TP >= Flag:都市_最大TP
	Flag:都市_現在TP = Flag:都市_最大TP

SIF Flag:都市_Lv >= 5 && FLAG:都市_防衛 == 0 &&  Flag:都市_襲撃 > 0
	FLAG:都市_襲撃 -= 1

SIF Flag:都市_Lv >= 5 && FLAG:都市_防衛 == 0 &&  Flag:都市_襲撃 <= 0
	CALL CITY_RID

SIF FLAG:都市_防衛 > 0
	FLAG:都市_防衛 -= 1
	
IF Flag:都市_Lv >= 5 && FLAG:都市_防衛 == 0 && Flag:都市_襲撃 == 0 && FLAG:都市_防衛蓄積ダメージ >= FLAG:都市_防衛成功ダメージ
	CALL CITY_RID_B_CLEAR
ELSEIF Flag:都市_Lv >= 5 && FLAG:都市_防衛 == 0 && Flag:都市_襲撃 == 0 && FLAG:都市_防衛蓄積ダメージ < FLAG:都市_防衛成功ダメージ
	CALL CITY_RID_B_MISS
ENDIF


IF Flag:都市_週 == 6
	Flag:都市_週 = 0
	SIF Flag:都市_防衛損壊率 > 0
		Flag:都市_防衛損壊率 -= 2+(RAND:3)
	SIF Flag:都市_防衛損壊率 < 0
		Flag:都市_防衛損壊率 = 0
ELSE
	Flag:都市_週 += 1
ENDIF



FLAG:都市_ニュース = RAND:16

IF Flag:都市_今期の締め切り == 0 && Flag:都市_今期の貢献値 == 0
	Flag:都市_今期の締め切り = 90
	 CALL TURN_EVENT_KSN
ELSEIF Flag:都市_今期の締め切り == 0
	CALL TURN_EVENT_KSN
ELSE
	Flag:都市_今期の締め切り -= 1
ENDIF

SIF !RAND:10
	Flag:都市_功績獲得機会 = 1



FLAG:都市_パートナーセックス = 0
FLAG:都市_ストーリー = RAND:11

Flag:日替わり区画難易度 = ((RAND:(Flag:都市_Lv))/20)+1
Flag:日替わり区画深度限界 = ((RAND:(Flag:都市_Lv))/10)+20
SIF Flag:日替わり区画難易度 >= 9
	Flag:日替わり区画難易度 = 9
SIF Flag:日替わり区画深度限界 >= 50
	Flag:日替わり区画深度限界 = 50
SIF Flag:調査区域 == 90
	Flag:調査深度 = 0


;CALL TURN_EVENT_CAFE_CHARA_MAIN


;-------------------------------------------------
;昼夜経過のイベント
;-------------------------------------------------
@TURN_EVENT_1(ARG)
#DIM L_I
#DIM L_P
#DIM L_TGT_BAK

L_TGT_BAK = TARGET

L_I = 0

SIF CHARANUM == 1
	RETURN

$IN_LOOP
	TARGET = L_I
	ARG =  L_I
	IF TARGET != MASTER  
		CALL C_M_AS(ARG:1)
		SIF FLAG:都市_現在TP > 0
			CFLAG:L_I:好感度 += (FLAG:都市_現在TP)*5
	ENDIF
	L_I += 1
	SIF L_I != CHARANUM
		GOTO IN_LOOP
TARGET = L_TGT_BAK

Flag:ターン調査済み = 0








SIF FLAG:都市_合計ファン数 >= 100000000
	FLAG:都市_合計ファン数 = 100000000
	
Flag:都市_現在TP += Flag:都市_最大TP
SIF Flag:都市_現在TP >= Flag:都市_最大TP
	Flag:都市_現在TP = Flag:都市_最大TP

;-------------------------------------------------
;ターン経過の悩み関連算出
;-------------------------------------------------
@TURN_EVENT_NAYAMI_K
#DIM L_LOOP
#DIM L_TGT_BAK

L_LOOP = 1
REPEAT 5
	IF CFlag:(4000+L_LOOP) == 100 ||CFlag:(4000+L_LOOP) == 101 ||CFlag:(4000+L_LOOP) == 102 ||CFlag:(4000+L_LOOP) == 103 ||CFlag:(4000+L_LOOP) == 105
		CFlag:住人_悩み金銭絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 202 ||CFlag:(4000+L_LOOP) == 302 ||CFlag:(4000+L_LOOP) == 303 ||CFlag:(4000+L_LOOP) == 500 ||CFlag:(4000+L_LOOP) == 501 ||CFlag:(4000+L_LOOP) == 502 ||CFlag:(4000+L_LOOP) == 600 ||CFlag:(4000+L_LOOP) == 601 ||CFlag:(4000+L_LOOP) == 102 
		CFlag:住人_悩み対人絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 404 
		CFlag:住人_悩み勉学絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 304 ||CFlag:(4000+L_LOOP) == 305 
		CFlag:住人_悩み食生絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 105 ||CFlag:(4000+L_LOOP) == 104 ||CFlag:(4000+L_LOOP) == 400 ||CFlag:(4000+L_LOOP) == 304 ||CFlag:(4000+L_LOOP) == 401 ||CFlag:(4000+L_LOOP) == 402 ||CFlag:(4000+L_LOOP) == 403
		CFlag:住人_悩み家庭絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 201 ||CFlag:(4000+L_LOOP) == 202 ||CFlag:(4000+L_LOOP) == 203 ||CFlag:(4000+L_LOOP) == 204 ||CFlag:(4000+L_LOOP) == 205 
		CFlag:住人_悩み恋愛絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 304 ||CFlag:(4000+L_LOOP) == 305 ||CFlag:(4000+L_LOOP) == 204 ||CFlag:(4000+L_LOOP) == 103 
		CFlag:住人_悩み病絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 500 ||CFlag:(4000+L_LOOP) == 501 ||CFlag:(4000+L_LOOP) == 502 ||CFlag:(4000+L_LOOP) == 503 
		CFlag:住人_悩み犯罪絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 602 ||CFlag:(4000+L_LOOP) == 603 ||CFlag:(4000+L_LOOP) == 604 ||CFlag:(4000+L_LOOP) == 605
		CFlag:住人_悩み性的絡み = 1
	ENDIF

	L_LOOP += 1
REND
L_LOOP = 11
REPEAT 5
	IF CFlag:(4000+L_LOOP) == 100 ||CFlag:(4000+L_LOOP) == 101 ||CFlag:(4000+L_LOOP) == 102 ||CFlag:(4000+L_LOOP) == 103 ||CFlag:(4000+L_LOOP) == 104||CFlag:(4000+L_LOOP) == 304
		CFlag:住人_悩み金銭絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 303 
		CFlag:住人_悩み対人絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 302 || CFlag:(4000+L_LOOP) == 404 
		CFlag:住人_悩み勉学絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 402 ||CFlag:(4000+L_LOOP) == 405 ||CFlag:(4000+L_LOOP) == 401 
		CFlag:住人_悩み食生絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 300 ||CFlag:(4000+L_LOOP) == 303 
		CFlag:住人_悩み家庭絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 200 ||CFlag:(4000+L_LOOP) == 201 ||CFlag:(4000+L_LOOP) == 202 ||CFlag:(4000+L_LOOP) == 203 ||CFlag:(4000+L_LOOP) == 600
		CFlag:住人_悩み恋愛絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 400 ||CFlag:(4000+L_LOOP) == 401 ||CFlag:(4000+L_LOOP) == 404 ||CFlag:(4000+L_LOOP) == 405 ||CFlag:(4000+L_LOOP) == 406 ||CFlag:(4000+L_LOOP) == 407 
		CFlag:住人_悩み病絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 500 ||CFlag:(4000+L_LOOP) == 501 ||CFlag:(4000+L_LOOP) == 502 
		CFlag:住人_悩み犯罪絡み = 1
	ELSEIF CFlag:(4000+L_LOOP) == 600 ||CFlag:(4000+L_LOOP) == 601 ||CFlag:(4000+L_LOOP) == 202 ||CFlag:(4000+L_LOOP) == 204
		CFlag:住人_悩み性的絡み = 1
	ENDIF
	L_LOOP += 1
REND


;-------------------------------------------------
;ターン経過の増減＆調整
;-------------------------------------------------
@TURN_EVENT_PERSONAL_END

IF TALENT:수정 == 0 && TALENT:妊娠 == 0
	CFLAG:受精現在耐久値 += CFLAG:受精最大耐久値/10
	IF CFLAG:受精現在耐久値 >= CFLAG:受精最大耐久値
		CFLAG:受精現在耐久値 = CFLAG:受精最大耐久値
	ENDIF
ENDIF

CFLAG:マンション経験獲得 = 0

CFLAG:子宮精液貯蔵量 -= CFLAG:子宮精液貯蔵量/3
CFLAG:子宮精液貯蔵量 -= 500

SIF CFLAG:子宮精液貯蔵量 <= 100
	CFLAG:子宮精液貯蔵量 = 0

IF TALENT:학생 && RAND:3 >= 1
	CFLAG:住人_業務ポイント += 1
	IF CFLAG:住人_業務ポイント >= (CFLAG:住人_貢献値/2)+3
		PRINTFORML %CALLNAME%는 업무 중에 경험을 얻어、새로운 공헌을 할 수 있게 되었다。
		PRINTFORMW 공헌도　【{CFLAG:住人_貢献値}→{(CFLAG:住人_貢献値)+1}】
		CFLAG:住人_業務ポイント = 0
		CFLAG:住人_貢献値 += 1
	ENDIF
ENDIF

SIF Talent:치안유지국직원 != 0
	CFLAG:住人_経験値 += RAND:3

;ここから調整
IF Talent:ＮＴＬ == 1 && Talent:미망인 == 1
	TALENT:ＮＴＬ = 0
	TALENT:결혼완료 = 0
ENDIF

SIF CFlag:住人_M兵装練度 == 0
	CFlag:住人_M兵装練度 = 1

SIF CFlag:住人_S兵装練度 == 0
	CFlag:住人_S兵装練度 = 1


;-------------------------------------------------
;ターン経過の悩み関連初期化
;-------------------------------------------------
@TURN_EVENT_NAYAMI_K_END

CFlag:住人_悩み金銭絡み = 0
CFlag:住人_悩み対人絡み = 0
CFlag:住人_悩み勉学絡み = 0
CFlag:住人_悩み食生絡み = 0
CFlag:住人_悩み家庭絡み = 0
CFlag:住人_悩み恋愛絡み = 0
CFlag:住人_悩み病絡み = 0
CFlag:住人_悩み犯罪絡み = 0
CFlag:住人_悩み性的絡み = 0

;-------------------------------------------------
;ターン経過のイベントの悩み解決
;-------------------------------------------------
@TURN_EVENT_NAYAMI
#DIM L_SP    ;NPCによる解決サポート
#DIM L_GET_AP;悩み解決による獲得成長値

IF CFlag:住人_悩み解決判定回数 > 0
	CFlag:住人_悩み解決判定回数 -= 1
	CFlag:住人_悩み解決中 += 1
	CALL VAR_NAYAMI_SET_ASSIST(TARGET)
ELSEIF CFlag:住人_悩み解決判定回数 == 0 && CFlag:住人_悩み解決中 > 0
	L_SP = 0
	IF FLAG:支援_悩み解決サポート == 1 && Flag:都市_現在SP >= 4
	L_SP += (CFlag:住人_悩み解決成功確立/5)+15
		Flag:都市_現在SP -= 4
	ENDIF
	REPEAT 3
		IF (CFlag:住人_悩み解決成功確立)+L_SP > RAND:100
			IF CFlag:住人_悩み解決選択 >= 10
				CFlag:住人_悩み解決合計加算 += RAND:15+20
				CFlag:住人_悩み成功回数 += 1
			ELSE
				CFlag:住人_悩み解決合計加算 += RAND:8+8
				CFlag:住人_悩み成功回数 += 1
			ENDIF
		ELSE
			CFlag:住人_悩み解決合計加算 += 1
		ENDIF
	REND
	DRAWLINE
	SETCOLOR 0,250,250
	PRINTFORML %CALLNAME%의 고민 해결 결과가 나왔습니다！
	RESETCOLOR
	PRINTFORM 【합계:
	IF CFlag:住人_悩み成功回数 >= 2
		SETCOLOR 0,250,250
		PRINTFORM 대성공
		CFlag:住人_悩み前回結果 = 2		;前回結果表示用
	ELSEIF CFlag:住人_悩み成功回数 >= 1
		SETCOLOR 0,250,250
		PRINTFORM 성공
		CFlag:住人_悩み前回結果 = 1		;前回結果表示用
	ELSE
		SETCOLOR 250,0,0
		PRINTFORM 실패
		CFlag:住人_悩み前回結果 = 0		;前回結果表示用
	ENDIF
	RESETCOLOR
	PRINTFORML 】
	PRINTFORML 【달성률】{CFlag:(4200+CFlag:住人_悩み解決選択)}　→　{CFlag:(4200+CFlag:住人_悩み解決選択)+CFlag:住人_悩み解決合計加算}
	PRINTFORMW 【호감도】{CFlag:好感度}　→　{CFlag:好感度+(20*CFlag:(4300+CFlag:住人_悩み解決選択))} 
	CFlag:好感度 += (20*CFlag:(4300+CFlag:住人_悩み解決選択))
	CFlag:(4200+CFlag:住人_悩み解決選択) += CFlag:住人_悩み解決合計加算
	CFlag:住人_悩み解決合計加算 = 0
	CFlag:住人_悩み解決中 = 0
	CFlag:住人_悩み成功回数 = 0
	CFLAG:住人_悩み協力状況 = 0
	RESETCOLOR
	CALL VAR_NAYAMI_SET_ASSIST(TARGET)
ENDIF

IF CFlag:(4200+CFlag:住人_悩み解決選択) >= 100
		CFlag:(4200+CFlag:住人_悩み解決選択) = 100
	L_GET_AP = CFlag:(4300+CFlag:住人_悩み解決選択) * 15 / 10
	CFlag:住人_悩み前回結果 = 3		;前回結果表示用

	SETCOLOR 0,250,250
	PRINTFORML %CALLNAME:MASTER%의 원조에 의해、%CALLNAME%が 가지고 있던 고민이 하나 해결되었습니다！
	PRINTFORMW 【최대 AP】{Flag:都市_最大AP}　→　{Flag:都市_最大AP+L_GET_AP}
	Flag:都市_最大AP += L_GET_AP
	Flag:都市_現在AP += L_GET_AP / 2
	IF CFlag:関係段階 == 0 && (CFlag:住人_悩み解決選択 >= 10)
		CFlag:関係段階 = 1
		SIF ABL:친밀 < 9
			ABL:친밀 += 1
		SIF ABL:농락 < 9
			ABL:농락 += 1
		PRINTFORMW 두 사람의 관계가【지인】에서【친구】가 되었습니다。
	ENDIF
	IF CFlag:関係段階 == 1 && (CFlag:住人_悩み解決選択 <= 9)
		CFlag:関係段階 = 2
		SIF ABL:친밀 < 9
			ABL:친밀 += 1
		SIF ABL:농락 < 9
			ABL:농락 += 1
		PRINTFORMW 두 사람의 관계가【친구】에서【베프】가 되었습니다。
	ENDIF
	IF CFlag:(4200+CFlag:住人_悩み解決選択) == 100
		CFlag:(4000+CFlag:住人_悩み解決選択) = 0
		CFlag:(4100+CFlag:住人_悩み解決選択) = 0
		CFlag:(4200+CFlag:住人_悩み解決選択) = 0
		CFlag:(4300+CFlag:住人_悩み解決選択) = 0
		CFlag:(4400+CFlag:住人_悩み解決選択) = 0
		CFlag:(4500+CFlag:住人_悩み解決選択) = 0
	ENDIF
	CFLAG:住人_悩み解決選択 = 0
	CALL VAR_NAYAMI_SET_ASSIST(TARGET)
ENDIF
RESETCOLOR




;-------------------------------------------------
;RPG回復
;-------------------------------------------------
@TURN_EVENT_RPG_P

IF CFlag:住人_현재체력 != CFlag:住人_최대체력 && CFlag:住人_現在気力 != CFlag:住人_最大気力
	DRAWLINE
	SETCOLOR 0,250,250
	PRINTFORML %CALLNAME%는 휴식을 취하면서 체력을 회복했다。
	RESETCOLOR
	DRAWLINE
ENDIF
CFlag:住人_현재체력 += CFlag:住人_최대체력/2
CFlag:住人_現在気力 = CFlag:住人_最大気力
CFlag:住人_現在BRE = CFlag:住人_最大BRE

SIF CFlag:住人_현재체력 >= CFlag:住人_최대체력
	CFlag:住人_현재체력 = CFlag:住人_최대체력



;-------------------------------------------------
;貢献
;-------------------------------------------------
@TURN_EVENT_CITY_EXP
#DIM L_T
#DIM L_LOOP
#DIM L_B
#DIM L_FH
#DIM L_FH2
#DIM L_FC
#DIM L_S

L_S = 0
L_FC = 0
L_FH = 0
L_FH2 = 0
L_B = 0
L_LOOP = 0


IF CFlag:住人_属性 == 2
	L_T = 80
ELSEIF CFlag:住人_属性 == 1
	L_T = 20
ELSE
	L_T = 50
ENDIF

L_FC = FLAG:都市_合計ファン数

SIF L_FC >= 50000000
	L_FC = 50000000
IF Talent:아이돌 != 0
	L_FH = 4000
ELSEIF Talent:사회인 != 0
	L_FH = 5000
ELSEIF Talent:학생
	L_FH = 5000
ELSEIF Talent:창녀 != 0
	L_FH = 7000
ELSEIF Talent:성직자 != 0
	L_FH = 500
	SIF RAND:10 > 4 && CFlag:住人_カルマ >= 1
		CFlag:住人_カルマ -= 1
ELSEIF Talent:메이드 != 0
	L_FH = 500
	IF Flag:都市_現在AP <= Flag:都市_最大AP
		Flag:都市_現在AP += (EXP:업무경험/40)+1
	ENDIF
ELSE
	L_FH = 2000
ENDIF


$FC_LOOP
IF L_FH >= L_FC
	L_FH2 += 1
	L_FH = L_FH*8
	GOTO FC_LOOP
ENDIF


SIF TALENT:정부 == 1
	L_S = (EXP:매춘경험+50)/50



SIF CFlag:住人_貢献値 <= 0
	CFlag:住人_貢献値 = 1


SIF TALENT:합의 == 1
	L_B = (CFlag:住人_貢献値/2)+1


IF (((CFlag:住人_地位)*10)+((CFlag:住人_貢献値)*10)+RAND:10) >= RAND:100
	IF L_T >= RAND:100
		;施設(悪)
		Flag:(4150+RAND:6) += (((RAND:(CFlag:住人_貢献値)+1)+L_B)*(L_FH2+1))+L_S
		Flag:都市_裏社会 += (RAND:(CFlag:住人_貢献値)+1)+L_B+RAND:(CFlag:住人_貢献値*2)
		Flag:都市_表社会 -= (RAND:(CFlag:住人_貢献値)+1)+L_B
	ELSE
		;施設(善)
		Flag:(4101+RAND:7) += (((RAND:(CFlag:住人_貢献値)+1)+L_B)*(L_FH2+1))+L_S
		Flag:都市_裏社会 -= (RAND:(CFlag:住人_貢献値)+1)+L_B+RAND:(CFlag:住人_貢献値*2)
		Flag:都市_表社会 += (RAND:(CFlag:住人_貢献値)+1)+L_B
	ENDIF

Flag:都市_経験値 += (RAND:(CFlag:住人_貢献値))+1+L_B
Flag:都市_今期の貢献値 += RAND:((CFlag:住人_貢献値)+1+L_B)

ENDIF
REPEAT 99
	IF (Flag:(4100+L_LOOP) >= (Flag:(4000+L_LOOP))*10 && Flag:(4000+L_LOOP) != 0) || (Flag:(4100+L_LOOP) >= 10 && Flag:(4000+L_LOOP) == 0)
		Flag:(4000+L_LOOP) += 1
		Flag:(4100+L_LOOP) = 0
	ENDIF
	L_LOOP += 1
REND


FLAG:都市_合計ファン数 += CFLAG:ファンの数

IF Flag:都市_経験値 >= (Flag:都市_Lv)*10
	Flag:都市_Lv += 1
	Flag:都市_経験値 = 0
ENDIF

SIF Flag:都市_裏社会 <= 0
	Flag:都市_裏社会 = 0
SIF Flag:都市_表社会  <= 0
	Flag:都市_表社会  = 0

Flag:都市_功績 += RAND:(((EXP:업무경험+1)/100)+3)

MONEY += (Flag:都市_Lv+1)*70+(RAND:(Flag:都市_Lv+1)*70)




;-------------------------------------------------
;キャラ来訪イベント制御
;-------------------------------------------------
@TURN_EVENT_CAFE_CHARA_MAIN
#LOCALSIZE 1
#LOCALSSIZE 1
#DIM  CHARA_LIST, 1000 ;キャラ一覧
#DIM  CHARA_CNT        ;キャラカウンタ
#DIMS DUMMY            ;REF対策で渡すだけ
CALLF MEMBER_LIST_ALL("CAFE", CHARA_LIST, CHARA_CNT)
CALL CHARA_SORT_CTRL(CHARA_LIST, CHARA_CNT, "好感度　　　내림차순", DUMMY)
CALL CHARA_SORT_CTRL(CHARA_LIST, CHARA_CNT, "協力状況내림차순", DUMMY)
FOR LOCAL, 0, CHARA_CNT
	PRINTFORMW 카페에서 느긋하게 쉬는 %CALLNAME:MASTER%의 앞에 %CALLNAME:(CHARA_LIST:LOCAL)%が 찾아왔다・・・
	CALL TURN_EVENT_CAFE_CHARA_COMING(CHARA_LIST:LOCAL)
	SIF RESULT < 0
		RETURN
NEXT



;あなたのもとにキャラがやってくるイベント
@TURN_EVENT_CAFE_CHARA_COMING(C_ID)
#DIM C_ID    ;キャラの登録番号
#DIM L_INPUT ;入力内容の一時保持
PRINTFORML 
DRAWLINE
CALL NAYAMI_PAGE(C_ID)
CALL C_PICTURE_T(C_ID)
CALL INFO_CITY_BASE
DRAWLINE
PRINTFORML 
IF FLAG:都市_現在TP <= 0
	PRINTFORML [-] - TP가 부족합니다
ELSEIF VAR_NAYAMI_ASSIST_ABLE_LIST(C_ID)
	PRINTFORML [3] - 고민을 듣는다(TP:1)
ELSE
	PRINTFORML [3] - 대화한다　(TP:1)
ENDIF
PRINTFORML [2] - 적당히 넘긴다（다른 여자를 기다린다）
PRINTFORML [1] - BP 섭취
PRINTFORML 
PRINTFORML [0] - 고민 상담 종료（모든 캐릭터）
DO
	INPUT
	L_INPUT = RESULT
	SELECTCASE L_INPUT
	CASE 3
		IF FLAG:都市_現在TP <= 0
			CALL C_INPUT_ERROR("TP가 부족합니다")
			CONTINUE
		ENDIF
		IF VAR_NAYAMI_ASSIST_ABLE_LIST(C_ID)
			CALL NAYAMI_CHALLENGE(C_ID)
			IF RESULT
				FLAG:都市_現在TP --
				CFLAG:C_ID:住人_悩み協力状況 = 1
				RETURN
			ENDIF
		ELSE
			FLAG:都市_現在TP --
			CALL CAFE_TALK2(C_ID)
		ENDIF
	CASE 2
		PRINTFORMW 적당히 흘리면서 다른 여자가 올 때까지 기다렸다
		PRINTFORML 
		RETURN
	CASE 1
		CALL SYSTEM_BP
	CASE 0
		PRINTFORML 오늘은 이쯤에서 그만두자
		RETURN -1
	CASEELSE
		$RETRY
		CALL C_INPUT_ERROR("無効な入力です")
		CONTINUE
	ENDSELECT
	BREAK
LOOP 1
RESTART



